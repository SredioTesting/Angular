#!/usr/bin/env node
'use strict';

// Provide a title to the process in `ps`
process.title = 'angular-cli';

const resolve = require('resolve');
const exit = require('exit');
const packageJson = require('../package.json');
const path = require('path');
const Leek = require('leek');

resolve('angular-cli', { basedir: process.cwd() },
  function (error, projectLocalCli) {
    var cli;
    if (error) {
      const nodeModulePath = path.join(__dirname, '../..');
      // Add the global ourselves to the NODE_PATH.
      if (!process.env['NODE_PATH'] || process.env['NODE_PATH'].split(path.delimiter).indexOf(nodeModulePath) == -1) {
        process.env['NODE_PATH'] = (process.env['NODE_PATH'] ? process.env['NODE_PATH'].split(path.delimiter) : [])
          .concat([nodeModulePath])
          .join(path.delimiter);

        require('shelljs').exec(process.argv.join(' '));
        return;
      }

      // If there is an error, resolve could not find the ember-cli
      // library from a package.json. Instead, include it from a relative
      // path to this script file (which is likely a globally installed
      // npm package). Most common cause for hitting this is `ember new`
      cli = require('../lib/cli');
    } else {
      // No error implies a projectLocalCli, which will load whatever
      // version of ember-cli you have installed in a local package.json
      cli = require(projectLocalCli);
    }

    if ('default' in cli) {
      cli = cli['default'];
    }

    cli({
      cliArgs: process.argv.slice(2),
      inputStream: process.stdin,
      outputStream: process.stdout,
      Leek: CustomLeek
    }).then(function (result) {
      var exitCode = typeof result === 'object' ? result.exitCode : result;
      exit(exitCode);
    });

    function CustomLeek(options) {
      options.trackingCode = packageJson.trackingCode;
      options.globalName = packageJson.name;
      options.name = packageJson.name;
      options.version = packageJson.version;
      return new Leek(options);
    }
  });
